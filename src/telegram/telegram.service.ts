import { Injectable, OnModuleInit } from '@nestjs/common'
import { Telegraf } from 'telegraf'
import { NotificationService } from '../notification/notification.service'
import { ConfigService } from '../shared/config/config.service'
import { getFormattedText } from '../shared/utils/textFormat.util'

@Injectable()
export class TelegramService implements OnModuleInit {
	private bot: Telegraf

	constructor(
		private configService: ConfigService,
		private notificationService: NotificationService
	) {
		const token = this.configService.getTelegramBotToken()

		this.bot = new Telegraf(token)
	}

	onModuleInit() {
		this.bot.start(ctx => {
			ctx.reply(
				`ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ‚ÐµÐ±Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ! ðŸŽ‰

Ð§Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð´Ð°Ñ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ñ‡Ð½Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¼ÐµÑ‚Ð¾Ðº Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ:

[Ð²Ñ€ÐµÐ¼Ñ]-[Ð²Ñ€ÐµÐ¼Ñ]-[Ð²Ñ€ÐµÐ¼Ñ] (Ð¸Ð»Ð¸ Ñ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ð¼Ð¸ Ñ‚Ð¸Ñ€Ðµ Ð¼ÐµÐ¶Ð´Ñƒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¼ÐµÑ‚ÐºÐ°Ð¼Ð¸)

Ð³Ð´Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ Ð² Ñ‡Ð°ÑÐ°Ñ…, Ð¼Ð¸Ð½ÑƒÑ‚Ð°Ñ…, Ð´Ð½ÑÑ… Ð¸Ð»Ð¸ Ð½ÐµÐ´ÐµÐ»ÑÑ….

ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹:

ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð·Ð° Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹:

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: 10Ð¼-5Ð¼

ÐŸÑ€Ð¸Ð¼ÐµÑ€: 10Ð¼-5Ð¼ â€” Ð±Ð¾Ñ‚ Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ñ‚ Ð²Ð°Ð¼ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð° 10 Ð¼Ð¸Ð½ÑƒÑ‚, Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð·Ð° 5 Ð¼Ð¸Ð½ÑƒÑ‚ Ð´Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ.

ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð·Ð° Ð´Ð½Ð¸:

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: 5Ð´-3Ð´-1Ð´

ÐŸÑ€Ð¸Ð¼ÐµÑ€: 5Ð´-3Ð´-1Ð´ â€” Ð±Ð¾Ñ‚ Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ñ‚ Ð²Ð°Ð¼ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð·Ð° 5 Ð´Ð½ÐµÐ¹, Ð·Ð°Ñ‚ÐµÐ¼ Ð·Ð° 3 Ð´Ð½Ñ, Ð¸ Ð½Ð°ÐºÐ¾Ð½ÐµÑ† Ð·Ð° 1 Ð´ÐµÐ½ÑŒ Ð´Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ.

Ð¡Ð¼ÐµÑˆÐ°Ð½Ð½Ñ‹Ðµ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ:

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: 10Ð¼-1Ð´-2Ð´

ÐŸÑ€Ð¸Ð¼ÐµÑ€: 10Ð¼-1Ð´-2Ð´ â€” Ð±Ð¾Ñ‚ Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ñ‚ Ð²Ð°Ð¼ Ð·Ð° 10 Ð¼Ð¸Ð½ÑƒÑ‚, Ð·Ð°Ñ‚ÐµÐ¼ Ð·Ð° 2 Ð´Ð½Ñ, Ð¸ Ð½Ð°ÐºÐ¾Ð½ÐµÑ† Ð·Ð° 1 Ð´ÐµÐ½ÑŒ Ð´Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ.

ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñ‹ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸:

Ð¼ â€” Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹

Ñ‡ â€” Ñ‡Ð°ÑÑ‹

Ð´ â€” Ð´Ð½Ð¸

Ð½ â€” Ð½ÐµÐ´ÐµÐ»Ð¸

m â€” minutes (Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹ ÑÐºÐ²Ð¸Ð²Ð°Ð»ÐµÐ½Ñ‚)

h â€” hours (Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹ ÑÐºÐ²Ð¸Ð²Ð°Ð»ÐµÐ½Ñ‚)

d â€” days (Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹ ÑÐºÐ²Ð¸Ð²Ð°Ð»ÐµÐ½Ñ‚)

w â€” weeks (Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹ ÑÐºÐ²Ð¸Ð²Ð°Ð»ÐµÐ½Ñ‚)

ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:

10Ð¼-5Ð¼ â€” Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸ Ð·Ð° 10 Ð¼Ð¸Ð½ÑƒÑ‚ Ð¸ Ð·Ð° 5 Ð¼Ð¸Ð½ÑƒÑ‚.

5Ð´-3Ð´-1Ð´ â€” Ð½Ð°Ð¿Ð¾Ð¼Ð½Ð¸ Ð·Ð° 5 Ð´Ð½ÐµÐ¹, 3 Ð´Ð½Ñ Ð¸ 1 Ð´ÐµÐ½ÑŒ.

Ð’ ÑÑ‚Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð±Ð¾Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ Ð²Ð°Ð¼ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ:

Ð—Ð° 10 Ð¼Ð¸Ð½ÑƒÑ‚.

Ð—Ð° 5 Ð¼Ð¸Ð½ÑƒÑ‚.

Ð—Ð° 5 Ð´Ð½ÐµÐ¹.

Ð—Ð° 3 Ð´Ð½Ñ.

Ð—Ð° 1 Ð´ÐµÐ½ÑŒ.

Ð’Ð°Ð¶Ð½Ð¾:

Ð’Ñ€ÐµÐ¼Ñ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¾ Ð´ÐµÑ„Ð¸ÑÐ°Ð¼Ð¸ (-). Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð»ÑŽÐ±Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¸Ñ€Ðµ â€” Ð¾Ð´Ð½Ð¾ Ð¸Ð»Ð¸ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾, Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»ÑÐ»Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚ÐºÐ¸.

Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ ÐµÐ´Ð¸Ð½Ð¸Ñ†Ñ‹ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ (Ð¼, Ñ‡, Ð´, Ð½, Ð¸Ð»Ð¸ Ð¸Ñ… Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ðµ ÑÐºÐ²Ð¸Ð²Ð°Ð»ÐµÐ½Ñ‚Ñ‹).

ÐÐ°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð±ÑƒÐ´ÑƒÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒÑÑ Ð² Ñ‚Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð²Ñ‹ Ð¸Ñ… ÑƒÐºÐ°Ð·Ð°Ð»Ð¸.

Ð•ÑÐ»Ð¸ Ð²ÑÐµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒ Ð¼Ð½Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¼ÐµÑ‚ÐºÐ°Ð¼Ð¸, Ð¸ Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÑŽ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÐ±Ñ! â°`
			)
		})

		this.bot.on('text', async ctx => {
			try {
				const userMessage = ctx.message.text
				const addedNotification =
					await this.notificationService.addNotification(userMessage)

				const message = getFormattedText(addedNotification)
				try {
					await ctx.reply(message, { parse_mode: 'HTML' })
				} catch (jsonError) {
					console.error('Error parsing AI response as JSON:', jsonError)
					ctx.reply(
						'ÐžÑ‚Ð²ÐµÑ‚ Ð˜Ð˜ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½ ÐºÐ°Ðº JSON. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹.'
					)
				}
			} catch (error) {
				console.error('Error in fetching AI response:', error)
				ctx.reply('Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ð¿Ð¾ÑˆÐ»Ð¾ Ð½Ðµ Ñ‚Ð°Ðº.')
			}
		})

		this.bot
			.launch()
			.then(() => {
				console.log('Bot started...')
			})
			.catch(err => {
				console.error('Error launching the bot: ', err)
			})
	}

	stopBot() {
		this.bot.stop('SIGINT')
	}
}
